{% extends "base_entrepreneur.html" %}
{% load static %}
{% load i18n %}
{% block title %}Tableau de bord - Entrepreneur{% endblock %}

{% block base_entrepreneur %}
<div class="container mt-5">
    <div class="text-center mb-5">
        <h2 class="fw-bold text-white">üëã Bienvenue {{ request.user.display_name }}</h2>
        <p class="text-muted">Voici un aper√ßu de vos projets et de leurs performances.</p>
    </div>

    <!-- Statistiques globales -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-center p-3 bg-light">
                <h5 class="text-secondary">Total Projets</h5>
                <h2 class="fw-bold text-dark">{{ total_projects }}</h2>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-center p-3 bg-success text-white">
                <h5>Approuv√©s</h5>
                <h2 class="fw-bold">{{ approved }}</h2>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-center p-3 bg-warning text-white">
                <h5>En attente</h5>
                <h2 class="fw-bold">{{ pending }}</h2>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-center p-3 bg-danger text-white">
                <h5>Rejet√©s</h5>
                <h2 class="fw-bold">{{ rejected }}</h2>
            </div>
        </div>
    </div>

    <!-- üí∞ Financement global -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <h5 class="card-title fw-bold mb-3">{% trans "Financement global" %}</h5>
            <p class="mb-1 text-muted">
                {% trans "Montant collect√© :" %} <strong>{{ total_collected|floatformat:0 }} FCFA</strong><br>
                {% trans "Objectif total :" %} <strong>{{ total_target|floatformat:0 }} FCFA</strong>
            </p>

            <div class="progress mt-2" style="height: 12px;">
                <div class="progress-bar {% if progress_global < 50 %}bg-warning {% elif progress_global < 100 %}bg-info {% else %}bg-success{% endif %}" role="progressbar" style="width:{{ progress_global }}%;" aria-valuenow="{{ progress_global }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>

            <p class="mt-2 small text-muted">
               {% trans "Progression globale :" %} <strong>{{ progress_global }}%</strong> 
            </p>

        </div>
    </div>

    <!-- Progression globale -->
    <div class="card mb-5 shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title text-primary">Progression globale</h5>
            <p class="mb-1 text-muted">
                Total collect√© : <strong>{{ total_collected|floatformat:2 }}</strong> /
                Objectif global : <strong>{{ total_projects|default:"0" }}</strong>
            </p>
            <div class="progress" style="height: 25px;">
                <div class="progress-bar bg-success fw-bold" role="progressbar"
                     style="width: {{ progress_global }}%;" aria-valuenow="{{ progress_global }}" 
                     aria-valuemin="0" aria-valuemax="100">
                    {{ progress_global }}%
                </div>
            </div>
        </div>
    </div>

    <!-- üìã Liste des projets r√©cents -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
            {% trans "Mes 5 derniers projets" %}
            <a href="{% url 'entrepreneur_project_list' %}" class="btn btn-outline-primary btn-sm">
               <i class="bi bi-folder2-open"></i> {% trans "Voir tout" %}
            </a>
        </div>
        <div class="card-body">
          {% if projects %}
            <div class="row g-4">
              {% for project in projects %}
                <div class="col-md-6 col-lg-4">
                  <div class="card shadow-sm border-0 h-100">
                      {% if project.image %}
                        <img src="{{ project.image.url }}" class="card-img-top" alt="{{ project.title }}" style="height:180px; object-fit:cover;">
                      {% else %}
                        <img src="{% static 'assets/img/projects/default.jpg' %}" class="card-img-top" alt="Default" style="height:180px; object-fit:cover;">
                      {% endif %}
                      <div class="card-body">
                          <h6 class="fw-bold">{{ project.title }}</h6>
                          <p class="text-muted small mb-1">
                              {% trans "Statut :" %} {{ project.get_status_display }}
                          </p>
                          <div class="progress mt-2 mb-2" style="height: 8px;">
                              <div class="progress-bar 
                                {% if project.progress < 50 %}bg-warning
                                {% elif project.progress < 100 %}bg-info
                                {% else %}bg-success{% endif %}"
                                role="progressbar"
                                style="width: {{ project.progress }}%;">
                              </div>
                          </div>
                          <small class="text-muted">
                              {{ project.total_collected_display|floatformat:0 }} / {{ project.target_amount|floatformat:0 }} FCFA
                               ({{ project.progress }}%)
                          </small>
                      </div>
                      <div class="card-footer bg-light border-0 d-flex justify-content-between">
                          <a href="{{ project.get_absolute_url }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye"></i> {% trans "Voir" %}  
                          </a>
                          <a href="{% url 'project_update' project.slug %}" class="btn btn-sm btn-outline-warning">
                            <i class="bi bi-pencil-square"></i>
                          </a>
                      </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
          <p class="text-muted text-center">{% trans "Aucun projet pour le moment." %}</p>
          {% endif %}
        </div>
    </div>

    <!-- üìä Graphique de financement -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light fw-bold">
            {% trans "Statistiques de financement par projet" %}
        </div>
        <div class="card-body">
           <canvas id="projectFundingChart" height="100"></canvas> 
        </div>
    </div>
    
</div>
<section class="withdrawal-section container mt-5 mb-5">
  <!-- Titre principal -->
  <div class="d-flex align-items-center mb-4">
    <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
      <i class="bi bi-wallet2 text-primary fs-3"></i>
    </div>
    <div>
      <h3 class="fw-bold text-primary mb-0">{% trans "Mes demandes de retrait" %}</h3>
      <p class="text-muted small mb-0">{% trans "Suivez vos retraits, leurs statuts et l‚Äô√©volution de vos fonds collect√©s." %}</p>
    </div>
  </div>

  <!-- ‚úÖ Statistiques globales -->
  <div class="row g-4 mb-4">
    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm rounded-4 stat-card text-center">
        <div class="card-body">
          <div class="icon-circle bg-primary bg-opacity-10 mb-2">
            <i class="bi bi-cash-coin text-primary fs-4"></i>
          </div>
          <h5 class="fw-bold mb-0">{{ total_requested|floatformat:0 }} FCFA</h5>
          <p class="text-muted small mb-0">{% trans "Total demand√©" %}</p>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm rounded-4 stat-card text-center">
        <div class="card-body">
          <div class="icon-circle bg-warning bg-opacity-10 mb-2">
            <i class="bi bi-hourglass-split text-warning fs-4"></i>
          </div>
          <h5 class="fw-bold mb-0">{{ total_pending }}</h5>
          <p class="text-muted small mb-0">{% trans "En attente" %}</p>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm rounded-4 stat-card text-center">
        <div class="card-body">
          <div class="icon-circle bg-success bg-opacity-10 mb-2">
            <i class="bi bi-check-circle text-success fs-4"></i>
          </div>
          <h5 class="fw-bold mb-0">{{ total_approved }}</h5>
          <p class="text-muted small mb-0">{% trans "Approuv√©es" %}</p>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm rounded-4 stat-card text-center">
        <div class="card-body">
          <div class="icon-circle bg-danger bg-opacity-10 mb-2">
            <i class="bi bi-x-circle text-danger fs-4"></i>
          </div>
          <h5 class="fw-bold mb-0">{{ total_rejected }}</h5>
          <p class="text-muted small mb-0">{% trans "Rejet√©es" %}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- üìä Tableau des demandes -->
  <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="table-responsive">
      <table class="table align-middle mb-0 table-hover text-center">
        <thead class="text-white" style="background: linear-gradient(90deg, #007bff, #00bcd4);">
          <tr>
            <th class="py-3">{% trans "Projet" %}</th>
            <th>{% trans "Montant" %}</th>
            <th>{% trans "Statut" %}</th>
            <th>{% trans "Date" %}</th>
            <th>{% trans "Actions" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for w in withdrawal_requests %}
          <tr class="align-middle">
            <td class="fw-semibold text-start ps-4">
              <i class="bi bi-folder2 me-1 text-primary"></i> {{ w.project.title }}
            </td>
            <td class="text-success fw-bold">{{ w.amount|floatformat:0 }} FCFA</td>
            <td>
              {% if w.status == "pending" %}
                <span class="badge bg-warning text-dark px-3 py-2 rounded-pill shadow-sm">
                  <i class="bi bi-hourglass-split me-1"></i> {% trans "En attente" %}
                </span>
              {% elif w.status == "approved" %}
                <span class="badge bg-success px-3 py-2 rounded-pill shadow-sm">
                  <i class="bi bi-check-circle me-1"></i> {% trans "Approuv√©e" %}
                </span>
              {% elif w.status == "rejected" %}
                <span class="badge bg-danger px-3 py-2 rounded-pill shadow-sm">
                  <i class="bi bi-x-circle me-1"></i> {% trans "Rejet√©e" %}
                </span>
              {% elif w.status == "paid" %}
                <span class="badge bg-primary px-3 py-2 rounded-pill shadow-sm">
                  <i class="bi bi-cash-coin me-1"></i> {% trans "Pay√©e" %}
                </span>
              {% endif %}
            </td>
            <td class="text-muted small"><i class="bi bi-calendar-event me-1"></i> {{ w.created_at|date:"d/m/Y" }}</td>
            <td>
              <button class="btn btn-outline-info btn-sm rounded-pill">
                <i class="bi bi-eye"></i> {% trans "D√©tails" %}
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center py-5">
              <i class="bi bi-inbox fs-3 text-muted d-block mb-2"></i>
              <p class="text-muted mb-0">{% trans "Aucune demande de retrait pour le moment." %}</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
<section class="mt-5 mb-4">
  <div class="container">
    <h4 class="fw-bold text-primary mb-4">
      <i class="bi bi-people"></i> {% trans "Contributions des investisseurs" %}
    </h4>

    {% for project in projects %}
    <div class="card shadow-sm mb-4 hover-shadow">
      <div class="row g-0">
        <div class="col-md-4">
          {% if project.image %}
            <img src="{{ project.image.url }}" class="img-fluid rounded-start" alt="{{ project.title }}">
          {% else %}
            <img src="{% static 'assets/img/default_project.jpg' %}" class="img-fluid rounded-start" alt="Default Project">
          {% endif %}
        </div>
        <div class="col-md-8">
          <div class="card-body">
            <h5 class="card-title fw-bold">{{ project.title }}</h5>
            <p class="text-muted mb-2">{{ project.short_description }}</p>
            <p class="mb-2">
              <span class="badge 
                {% if project.status == 'approved' %}bg-success
                {% elif project.status == 'pending' %}bg-warning text-dark
                {% elif project.status == 'rejected' %}bg-danger
                {% elif project.status == 'completed' %}bg-info text-dark
                {% else %}bg-secondary{% endif %}">
                {{ project.get_status_display }}
              </span>
              <small class="text-muted ms-2">
                <i class="bi bi-geo-alt"></i> {{ project.country.name }}
              </small>
            </p>

            <!-- üîπ Progression globale du projet -->
            <div class="mb-3">
              <div class="d-flex justify-content-between mb-1">
                <small>{% trans "Progression du projet" %}</small>
                <small>{{ project.progress }}%</small>
              </div>
              <div class="progress" style="height: 8px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ project.progress }}%" aria-valuenow="{{ project.progress }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>

            <!-- üîπ Contributions -->
            {% if project.contributions %}
            <h6 class="mt-3 mb-2">{% trans "Contributions" %}</h6>
            <ul class="list-group list-group-flush">
              {% for contribution in project.contributions %}
              <li class="list-group-item d-flex justify-content-between align-items-center p-2">
                <span>{{ contribution.investor_name }}</span>
                <span class="d-flex align-items-center gap-2">
                  <small>{{ contribution.amount }} EURO</small>
                  <span class="badge bg-primary">{{ contribution.percentage }}%</span>
                </span>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted fst-italic mt-2">{% trans "Aucune contribution pour ce projet." %}</p>
            {% endif %}

          </div>
        </div>
      </div>
    </div>
    {% endfor %}

  </div>
</section>
<script>
  const ctx2 = document.getElementById('statusChart').getContext('2d');
  const statusChart = new Chart(ctx2, {
    type: 'doughnut',
    data: {
      labels: ["{% trans 'Valid√©s' %}", "{% trans 'En attente' %}", "{% trans 'Rejet√©s' %}"],
      datasets: [{
        data: [{{ approved }}, {{ pending }}, {{ rejected }}],
        backgroundColor: [
          'rgba(75, 192, 192, 0.6)',
          'rgba(255, 206, 86, 0.6)',
          'rgba(255, 99, 132, 0.6)'
        ],
        borderColor: ['#fff'],
        borderWidth: 2
      }]
    },
    options: {
      plugins: {
        title: {
          display: true,
          text: '{% trans "R√©partition des statuts" %}',
          font: { size: 16, weight: 'bold' }
        }
      }
    }
  });
</script>
{% endblock base_entrepreneur %}
